name: 更新每周地图推荐

on:
  schedule:
    # 每周五北京时间8点运行 (UTC+8)
    - cron: '0 0 * * 5'
  workflow_dispatch:  # 允许手动触发

jobs:
  update-recommendations:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML

    - name: 运行地图推荐更新脚本
      run: |
        python scripts/update_map_recommendations.py

    - name: 检查文件变更
      id: git-check
      run: |
        echo "变更的文件："
        git status --porcelain
        echo "has_changes=$(git status --porcelain | wc -l)" >> $GITHUB_OUTPUT

    - name: 提交变更
      if: steps.git-check.outputs.has_changes != '0'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/src/posts/map/pcl_sub_file.xaml
        git commit -m "🤖 自动更新每周地图推荐 [$(date +'%Y-%m-%d %H:%M')]"
        git push